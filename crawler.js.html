<!DOCTYPE html>
<html>
<head>
  <title>crawler.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="doc-style.css" />
  <script src="doc-filelist.js"></script>
  <script>
    var relativeDir = "", thisFile = "crawler.js", defaultSidebar = true;
  </script>
  <script src="doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#queue">Queue</a>
      </div>
      <div class="heading h2">
        <a href="#getrandominrange">getRandomInRange</a>
      </div>
      <div class="heading h2">
        <a href="#setrandomtimeout">setRandomTimeout</a>
      </div>
      <div class="heading h2">
        <a href="#createqueue">createQueue</a>
      </div>
      <div class="heading h2">
        <a href="#getqueue">getQueue</a>
      </div>
      <div class="heading h1">
        <a href="#process-crawl-request">Process Crawl-Request</a>
      </div>
      <div class="heading h2">
        <a href="#processrequest">processRequest</a>
      </div>
      <div class="heading h1">
        <a href="#export">Export</a>
      </div>
      <div class="heading h2">
        <a href="#waitforsetup">waitForSetup</a>
      </div>
      <div class="heading h2">
        <a href="#process">process</a>
      </div>
      <div class="heading h2">
        <a href="#setupphantom">setupPhantom</a>
      </div>
      <div class="heading h2">
        <a href="#exports.process">exports.process</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>crawler.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">phantom</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;node-phantom&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>Change this path, if you want to place the phantomjs-binary somewhere else.
The path is relative to this file.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">PHANTOM_BINARY</span> <span class="o">=</span> <span class="s1">&#39;/bin/phantomjs&#39;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>Specifies the timeout between requests to one host (in ms).
The actual timeout will be randomly between min and max.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">MIN_TIMEOUT</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">MAX_TIMEOUT</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>This will be initialized on first call to <code>exports.process()</code>.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">phantomjs</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="queue">
  <h1>
    <a href="#queue" class="pilcrow">&#182;</a>
    Queue
  </h1>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="getrandominrange">
  <h2>
    <a href="#getrandominrange" class="pilcrow">&#182;</a>
    getRandomInRange
  </h2>
</div>

  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">min</span>
      <span class="dox_type">Number</span>
      <span>lower limit</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">max</span>
      <span class="dox_type">Number</span>
      <span>upper limit</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>a random number between min and max</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">getRandomInRange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">min</span><span class="p">,</span> <span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">min</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nx">max</span><span class="o">-</span><span class="nx">min</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="setrandomtimeout">
  <h2>
    <a href="#setrandomtimeout" class="pilcrow">&#182;</a>
    setRandomTimeout
  </h2>
</div>


<p>Calls callback after a random amount of time, 
that is between MIN_TIMEOUT and MAX_TIMEOUT.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">callback</span>
      <span class="dox_type">function()</span>
      <span>called after random time</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">setRandomTimeout</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">time</span> <span class="o">=</span> <span class="nx">getRandomInRange</span><span class="p">(</span><span class="nx">MIN_TIMEOUT</span><span class="p">,</span> <span class="nx">MAX_TIMEOUT</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">time</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="createqueue">
  <h2>
    <a href="#createqueue" class="pilcrow">&#182;</a>
    createQueue
  </h2>
</div>

  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">processFunction</span>
      <span class="dox_type">function(item</span>
      <span class="dox_type">callback)</span>
      <span>processes the given item
and calls callback when done.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">createQueue</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">processFunction</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">var</span> <span class="nx">running</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>Adds an item to the queue and 
starts periodical processing if not already running.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">addToQueue</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">items</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">running</span><span class="p">)</span>
      <span class="nx">processPeriodically</span><span class="p">();</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>Takes items from the queue and processes them one after another 
(with random timeout) until no more are available.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">processPeriodically</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">running</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">setRandomTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">items</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="nx">processFunction</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> 
          <span class="nx">running</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">else</span> 
          <span class="nx">processPeriodically</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<div class="dox">
  <div class="summary">
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">function(anything)</span>
      <span><strong>process</strong> see addToQueue</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">process</span><span class="o">:</span> <span class="nx">addToQueue</span>
  <span class="p">};</span>

<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="getqueue">
  <h2>
    <a href="#getqueue" class="pilcrow">&#182;</a>
    getQueue
  </h2>
</div>


<p>Retrieves the queue for a given host or creates one.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">host</span>
      <span class="dox_type">String</span>
      <span>the host of a requested url</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Queue</span>
      <span>the queue for the given host</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">getQueue</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>Maps from host to Queue.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">queues</span> <span class="o">=</span> <span class="p">{};</span>
  
  <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">host</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">queues</span><span class="p">[</span><span class="nx">host</span><span class="p">])</span>
      <span class="nx">queues</span><span class="p">[</span><span class="nx">host</span><span class="p">]</span> <span class="o">=</span> <span class="nx">createQueue</span><span class="p">(</span><span class="nx">processRequest</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="nx">queues</span><span class="p">[</span><span class="nx">host</span><span class="p">];</span>
  <span class="p">};</span>

<span class="p">})();</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="process-crawl-request">
  <h1>
    <a href="#process-crawl-request" class="pilcrow">&#182;</a>
    Process Crawl-Request
  </h1>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>The type <strong>Request</strong> looks like this:</p>


<div class="highlight"><pre><code><span class="p">{</span>
  <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://myhost.com/site-to-crawl.html&#39;</span><span class="p">,</span>
  <span class="nx">extractorFunction</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{},</span>
  <span class="nx">callback</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{},</span>
  <span class="nx">scripts</span><span class="o">:</span> <span class="nb">String</span><span class="p">[],</span> <span class="nx">optional</span>
<span class="p">}</span>
</code></pre></div>


        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="processrequest">
  <h2>
    <a href="#processrequest" class="pilcrow">&#182;</a>
    processRequest
  </h2>
</div>


<p>Makes a HTTP-Request for request.url and extracts data from the page's 
context using request.extractFunction.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">request</span>
      <span class="dox_type">Request</span>
      <span>the queued Crawl-Request</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">callback</span>
      <span class="dox_type">function()</span>
      <span>to signal when the request has finished</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">processRequest</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>Creates the page and opens the url given by <code>request.url</code>.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">createPage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">phantomjs</span><span class="p">.</span><span class="nx">createPage</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">page</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">page</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>Injects all scripts, that were given via <code>request.scripts</code>.
Load script from a server if it starts with http or https.
Otherwise it will be loaded from local file system.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">injectScripts</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">page</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">scripts</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">scripts</span> <span class="o">||</span> <span class="p">[];</span>

    <span class="kd">var</span> <span class="nx">injectScript</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">script</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">isRemoteFile</span> <span class="o">=</span> <span class="nx">script</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;http://&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> 
                         <span class="nx">script</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;https://&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">includeFunction</span> <span class="o">=</span> <span class="nx">isRemoteFile</span> <span class="o">?</span> <span class="s1">&#39;includeJs&#39;</span> <span class="o">:</span> <span class="s1">&#39;injectJs&#39;</span><span class="p">;</span>
      <span class="nx">page</span><span class="p">[</span><span class="nx">includeFunction</span><span class="p">](</span><span class="nx">script</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">injectAll</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">number</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">number</span> <span class="o">=</span> <span class="nx">number</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">number</span> <span class="o">&gt;=</span> <span class="nx">scripts</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">script</span> <span class="o">=</span> <span class="nx">scripts</span><span class="p">[</span><span class="nx">number</span><span class="p">];</span>
      <span class="nx">injectScript</span><span class="p">(</span><span class="nx">script</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span>
         <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="nx">injectAll</span><span class="p">(</span><span class="nx">number</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">};</span>

    <span class="nx">injectAll</span><span class="p">();</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>Extracts data from the page using <code>request.extractFunction</code>.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">extractData</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">page</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">page</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">extractFunction</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>Then actually perform the steps and handle errors.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;processing request&#39;</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
  <span class="nx">createPage</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">page</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">injectScripts</span><span class="p">(</span><span class="nx">page</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">page</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">extractData</span><span class="p">(</span><span class="nx">page</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">page</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="nx">request</span><span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;processed request&#39;</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

        <span class="nx">page</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>Call the request.callback to return the result and 
the local callback to notify the queu, that the extraction has ended.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">request</span><span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
        <span class="nx">callback</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>

<span class="p">};</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="export">
  <h1>
    <a href="#export" class="pilcrow">&#182;</a>
    Export
  </h1>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitforsetup">
  <h2>
    <a href="#waitforsetup" class="pilcrow">&#182;</a>
    waitForSetup
  </h2>
</div>


<p>Creates a function, which makes sure, that setupFunction completed 
(signaled by setupFunction's callback), before the regularFunction is called.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">setupFunction</span>
      <span class="dox_type">function(callback)</span>
      <span>sets up some needed resources</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">regularFunction</span>
      <span class="dox_type">function</span>
      <span>does something, that needs the set up resources</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">waitForSetup</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">setupFunction</span><span class="p">,</span> <span class="nx">regularFunction</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">status</span> <span class="o">=</span> <span class="s1">&#39;initial&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="p">[];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>Stores the given args in the queue.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">putInQueue</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>This function is called as callback from the setupFunction.
It makes all previously queued calls to regularFunction.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">onComplete</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">status</span> <span class="o">=</span> <span class="s1">&#39;complete&#39;</span><span class="p">;</span>
    <span class="nx">queue</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">regularFunction</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>The first time: call setupFunction and queue the call to regularFunction.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">===</span> <span class="s1">&#39;initial&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">status</span> <span class="o">=</span> <span class="s1">&#39;waiting&#39;</span><span class="p">;</span>
      <span class="nx">setupFunction</span><span class="p">(</span><span class="nx">onComplete</span><span class="p">);</span>
      <span class="nx">putInQueue</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>While setupFunction has not completed: queue the call to regularFunction.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">===</span> <span class="s1">&#39;waiting&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">putInQueue</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>After setupFunction has completed: actually call regularFunction.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">regularFunction</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>

<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="process">
  <h2>
    <a href="#process" class="pilcrow">&#182;</a>
    process
  </h2>
</div>


<p>Queues crawling of given pageUrl with extractFunction.
Injects local and remote scripts before extraction, if some are given.
The callback will be called with results after data has been extracted.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">request</span>
      <span class="dox_type">Request</span>
      <span>Object that holds the options listed below.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">url</span>
      <span class="dox_type">String</span>
      <span>url to the page that should be crawled</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">scripts</span>
      <span class="dox_type">String[]</span>
      <span>local or remote scripts to be injected (optional)</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">extractFunction</span>
      <span class="dox_type">function</span>
      <span>function that is executed in the page's context</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">callback</span>
      <span class="dox_type">function(error</span>
      <span class="dox_type">result)</span>
      <span>called after extractFunction was executed</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">process</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>Acquires queue for host of pageUrl.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">host</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="nx">getQueue</span><span class="p">(</span><span class="nx">host</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>Lets that queue process the request.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">queue</span><span class="p">.</span><span class="nx">process</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="setupphantom">
  <h2>
    <a href="#setupphantom" class="pilcrow">&#182;</a>
    setupPhantom
  </h2>
</div>


<p>Creates a PhantomJS brower and stores it's reference to field <code>phantomjs</code>.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">callback</span>
      <span class="dox_type">function</span>
      <span>to signal that the setup has completed</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">setupPhantom</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">phantom</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ph</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">phantomjs</span> <span class="o">=</span> <span class="nx">ph</span><span class="p">;</span>
    <span class="nx">callback</span><span class="p">();</span>
  <span class="p">},</span> <span class="p">{</span> <span class="nx">phantomPath</span><span class="o">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="nx">PHANTOM_BINARY</span> <span class="p">});</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="exports.process">
  <h2>
    <a href="#exports.process" class="pilcrow">&#182;</a>
    exports.process
  </h2>
</div>


<p>Makes sure that setupPhantom has completed before calling process</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">setupPhantom, process
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">exports</span><span class="p">.</span><span class="nx">process</span> <span class="o">=</span> <span class="nx">waitForSetup</span><span class="p">(</span><span class="nx">setupPhantom</span><span class="p">,</span> <span class="nx">process</span><span class="p">);</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
